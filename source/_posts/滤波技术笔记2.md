---
layout: post
title: "滤波技术笔记 (II): Kalman Filter实例"
categories:
  - "滤波技术笔记"
tags:
  - "Kalman Filter"
  - "卡尔曼增益"
draft: false
id: 654
date: 2014-05-18 10:43:15
toc_number_disable: true
cover_img: /blog/post_cover_images/kalman.png
cover_img_from_root: true
description:
comments:
---

### 再举一个例子

记得我们上次讲Kalman Filter的时候是在[这里](/blog/滤波技术笔记1)，在上篇的基础上，我们再进一步给出一个帮助理解的例子，是从[^1]的页面上直接搬过来的:

考虑在无摩擦的、无限长的直轨道上的一辆车。该车最初停在位置0处，但时不时受到随机的冲击。注意这里我们考虑没有外力的影响，因此忽略掉 $ \mathbf{B}_k $ 和  $ \mathbf{u}_k $。同时考虑 $ \mathbf{F}, \mathbf{H}, \mathbf{R}, \mathbf{Q}  $ 为常数，此处不用下标。

我们每 $ \Delta t $ 秒即测量车的位置，但是这个测量是非精确的；我们想建立一个关于其位置以及速度的模型。车的位置以及速度（或者更加一般的，一个粒子的运动状态）可以被线性状态空间描述如下：

> $ \mathbf{x_k} = \begin{bmatrix} x \\\ \dot{x} \end{bmatrix} $

这其中，$ \dot{x} $ 是速度，即位置对时间的导数。

假设在 $ k-1 $ 时刻和 $ k $ 时刻之间，车受到 $ a_k $ 的加速度，且符合均值为0，标准差为 $ \sigma_a $ 的正态分布。根据牛顿第一定理，我们推出：

> $ \mathbf{x}_k = $ $ \mathbf{F} \cdot \mathbf{x}_{k-1} + \mathbf{G} \cdot a_k $

其中，两个转移矩阵

> $\mathbf{F} = \begin{bmatrix} 1 & \Delta t \\\ 0 & 1 \end{bmatrix}$

> $\mathbf{G} = \begin{bmatrix} \Delta t^2/2 \\\ {\Delta t} \end{bmatrix}$

可知

> $ \mathbf{Q} = \text{cov}(\mathbf{G} \cdot a) = E[(\mathbf{G} \cdot a) \cdot (\mathbf{G} \cdot a)^{T}] = \mathbf{G} \cdot E[a^2] \cdot \mathbf{G}^T = \mathbf{G} \cdot \sigma_a^{2} \cdot \mathbf{G}^T $

每一个时刻我们都会对其进行一个测量过程，测量受到噪声干扰，我们依然假设噪声服从正态分布，均值为0，标准差为 $ \sigma_z $。

> $ z_k = \mathbf{H} \cdot x_k + v_k $

其中，我们有

> $ \mathbf{H} = \begin{bmatrix} 1 & 0 \end{bmatrix} $ $ \mathbf{R} = E[v_k \cdot v_k^T] = \sigma_z^2 $

我们先要提出一个假设初始值，假设车最初的位置和速度是足够准确的：

> $ x_{0|0} = \begin{bmatrix} 0 \\\ 0  \end{bmatrix} $

并且，告诉滤波器初始的测量是准确的，给出一个协方差矩阵：

> $ P_{0|0} = \begin{bmatrix} 0 & 0 \\\ 0 & 0  \end{bmatrix} $

如果我们不确切知道最初的位置与速度，协方差矩阵可以初始化为一个对角线元素为 $ B $ 的矩阵，$ B $ 取一个比较大的数

> $ P_{0|0} = \begin{bmatrix} B & 0 \\\ 0 & B  \end{bmatrix} $

接下来我们就可以给出 $ 0 + \Delta_t $ 时刻对于车的状态的估计：

> $ x_{1|0}$ = $\begin{bmatrix} 1 & \Delta t \\\ 0 & 1 \end{bmatrix}$ $\cdot \begin{bmatrix} 0 \\\ 0  \end{bmatrix}$ + $\begin{bmatrix} \Delta t^2/2 \\\ \Delta t \end{bmatrix}$ $\cdot a_0$ = $\begin{bmatrix} a_0 \cdot \Delta t^2/2 \\\ \Delta t \cdot a_0 \end{bmatrix}$

上个公式中的 $ \begin{bmatrix} a_0 \cdot \Delta t^2/2 \\\ \Delta t \cdot a_0 \end{bmatrix} $ 也就是 $ 0 + \Delta_t $ 时刻的位移和速度的估计。

接下来，我们还可以得到预测的估计协方差矩阵：

> $ P_{1|0} = \begin{bmatrix} 1 & \Delta t \\\ 0 & 1 \end{bmatrix} \cdot \begin{bmatrix} 0 & 0 \\\ 0 & 0  \end{bmatrix} \cdot \begin{bmatrix} 1 & 0 \\\ \Delta t & 1 \end{bmatrix} + \begin{bmatrix} \Delta t^2/2 \\\ \Delta t \end{bmatrix} \cdot \sigma_a^2 \cdot \begin{bmatrix} \Delta t^2/2 & \Delta t \end{bmatrix} = $ $\sigma_a^2 \cdot \begin{bmatrix} \Delta t^4/4 & \Delta t^3/2 \\\ \Delta t^3/2 & {\Delta t}^2 \end{bmatrix} $

注意这个时候预测的估计协方差矩阵 $ P_{1|0} $ 相比 $ P_{0|0} $ 就大一些，这主要是由于预测过程带来的误差。

有了上述的两个预测值，假设我们得到了$ 0 + \Delta_t $ 时刻的估计值，因为假设 $ \mathbf{H} = \begin{bmatrix} 1 & 0 \end{bmatrix} $ ，我们在观测值上有：

> $ z_{1|1} = x_1 $

也就是说只能观测到车的位置，不能观测到车的速度 $ \dot{x_1} $。

我们可以计算得到测量余量，当然

> $ y_{1|1} = x_1  - \begin{bmatrix} 1 & 0 \end{bmatrix} \cdot \begin{bmatrix} a_0 \cdot \Delta t^2/2 \\\ \Delta t \cdot a_0 \end{bmatrix} = x_1 - a_0 \cdot \Delta t^2/2 $

有了测量余量，其实可以得到测量余量的协方差：

> $ S_{1|1} = \begin{bmatrix} 1 & 0 \end{bmatrix} \cdot P_{1|0} \cdot \begin{bmatrix} 1 \\\ 0 \end{bmatrix} + {\sigma_z}^2 = {\sigma_a}^2 \cdot \Delta t^4/4 + {\sigma_z}^2$

接下来，可以计算出卡尔曼增益：

> $ K_{1|1} = P_{1|0} \cdot \begin{bmatrix} 1 \\\ 0 \end{bmatrix} / ({\sigma_a}^2 \cdot \Delta t^4/4 + {\sigma_z}^2) = $
$\sigma_a^2 \cdot \begin{bmatrix} \Delta t^4/4 \\\ \Delta t^3/2 \end{bmatrix} / ({\sigma_a}^2 \cdot \Delta t^4/4 + {\sigma_z}^2) $

有了卡尔曼增益，我们可以更新 $ x_{1|1} $ 和 $ P_{1|1} $ ：

> $ x_{1|1} = x_{1|0} + K_{1|1} \cdot y_{1|1} = $ $\begin{bmatrix} a_0 \cdot \Delta t^2/2 \\\ \Delta t \cdot a_0 \end{bmatrix} + \sigma_a^2 \cdot \begin{bmatrix} \Delta t^4/4 \\\ \Delta t^3/2 \end{bmatrix} / ({\sigma_a}^2 \cdot \Delta t^4/4 + {\sigma_z}^2) \cdot (x_1 - a_0 \cdot \Delta t^2/2) $

上述我们就做出了一个更新阶段的状态的估计，看到上述方程中只涉及到预测的变量和当前阶段的观测值，接下来是更新阶段的协方差矩阵估计：

> $ P_{1|1} = (1 - K_{1|1} \cdot \begin{bmatrix} 1 & 0 \end{bmatrix} ) \cdot P_{1|0} = $
$\sigma_a^2 \cdot \begin{bmatrix} 1 - \Delta t^4/4 & 0 \\\ 1 - \Delta t^3/2  & 0 \end{bmatrix} / ({\sigma_a}^2 \cdot \Delta t^4/4 + {\sigma_z}^2) \cdot \sigma_a^2 \cdot \begin{bmatrix} \Delta t^4/4 & \Delta t^3/2 \\\ \Delta t^3/2 & {\Delta t}^2 \end{bmatrix} $ $= {\sigma_a}^4 / (16 \cdot ({\sigma_a}^2 \cdot \Delta t^4/4 + {\sigma_z}^2)) \begin{bmatrix} 4{\Delta t}^4 - {\Delta t}^8 & 8{\Delta t}^3 - 2{\Delta t}^7 \\\ 4{\Delta t}^4 - 2{\Delta t}^7 & 8{\Delta t}^3 - 4{\Delta t}^6 \end{bmatrix} $


### 流程

公式是不是很复杂，但是只要你跟着流程来一趟，应该能够明白KF的整个过程。跑完这个例子之后，我们把整个流程抽象出来：

1.  先决定当前系统的初始状态，并根据预测方程得到一个下一个时刻预测的状态；
2.  根据预测方程中过程的误差，得到当前预测的协方差估计；
3.  进入更新阶段，我们根据目前系统的观测值和上一个时刻预测的状态，从转换方程入手，得到一个测量余量；
4.  根据转换方程和上个时刻预测的协方差估计，也可以得到一个测量余量的协方差估计；
5.  根据测量余量的协方差、转换方程和上个时刻的预测协方差估计，我们得到卡尔曼增益；
6.  根据卡尔曼增益和测量余量，我们从预测的状态中更新优化当前的状态的值，而这个值可以用来预测下一个时刻的状态；
7.  同样，我们根据卡尔曼增益和上个时刻的预测协方差估计，我们把当前更新阶段的协方差估计也得到，帮助下一刻时候的卡尔曼增益计算.

最后我们应该回过头来看看上一篇中讲的房间温度的例子，来对比下这个过程。

### 再给出一些参考

可以查看[^2]查看一个关于KF的tutorial，它对应的一个中文版本可见[^3]。

### 引用

[^1]: [http://en.wikipedia.org/wiki/Kalman_filtering](http://en.wikipedia.org/wiki/Kalman_filtering)
[^2]: [Understanding the Basis of the Kalman Filter Via a Simple and Intuitive Derivation](http://www.cl.cam.ac.uk/~rmf25/papers/Understanding%20the%20Basis%20of%20the%20Kalman%20Filter.pdf)
[^3]: [理解卡尔曼滤波器 (Understanding Kalman Filter) - RioDream - SegmentFault](https://segmentfault.com/a/1190000000514987)
